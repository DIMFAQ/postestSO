<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Study Case Gacha â€” Drone / IT Labs</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#60a5fa;
      --muted:#93c5fd33;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --gap:12px;
      --fw:600;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#071023 0%, #071627 70%); color:#e6eef8}
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:0;padding:9px 12px;border-radius:10px;color:#04243a;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid var(--muted);color:var(--accent);padding:7px 10px;border-radius:10px}
    button[disabled]{opacity:0.45;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:var(--gap);margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-height:120px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer}
    .card h3{margin:0 0 8px 0;font-size:15px}
    .card p{margin:0;font-size:13px;color:#bcd5efcc}
    .tag{font-size:12px;padding:6px 8px;border-radius:999px;background:var(--glass);display:inline-block;margin-right:6px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .selected{outline:3px solid rgba(96,165,250,0.14);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .card-timer{
      background:rgba(96,165,250,0.12);
      color:var(--accent);
      padding:6px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      min-width:64px;
      text-align:center;
      margin-left:8px;
    }
    /* modal */
    .modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6), rgba(2,6,23,0.6));backdrop-filter: blur(6px);padding:20px;z-index:50}
    .modal{max-width:900px;width:100%;background:linear-gradient(180deg, #071124, #041023);border-radius:10px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    .steps{margin-top:10px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;max-height:56vh;overflow:auto}
    .steps ol{padding-left:18px;margin:0}
    .steps li{margin:8px 0;padding-left:8px}
    .permTable{margin-top:10px;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02)}
    .permRow{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .permRow:last-child{border-bottom:0}
    /* copy modal */
    .copyModalContent{display:flex;flex-direction:column;gap:8px}
    textarea.copyArea{width:100%;min-height:160px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    /* full-screen post-gacha overlay */
    .overlayFull {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, rgba(2,6,23,0.95), rgba(2,6,23,0.98));
      color: white;
      display: none;
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 28px;
    }
    .overlayCard {
      max-width:1100px;
      width:100%;
      background: linear-gradient(180deg,#071124,#041023);
      border-radius:12px;
      padding:26px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 20px 60px rgba(2,6,23,0.7);
      text-align: left;
      color: #e6eef8;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 18px;
      align-items: start;
    }
    .overlayLeft { padding-right: 8px; }
    .overlayRight {
      background: rgba(255,255,255,0.02);
      padding: 16px;
      border-radius: 10px;
      text-align: center;
    }
    .overlayCard h2 { margin: 0 0 6px 0; font-size: 20px; }
    .overlayCard p { color: #cfe7ffcc; margin: 8px 0 12px; }
    .bigTimer {
      font-size:36px;
      font-weight:800;
      margin:8px 0;
      color: var(--accent);
    }
    .progressBar {
      height:10px;
      background:rgba(255,255,255,0.04);
      border-radius:999px;
      overflow:hidden;
      margin-top:8px;
    }
    .progressFill {
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(96,165,250,0.9), rgba(96,165,250,0.6));
      transition: width 0.4s linear;
    }
    .overlayControls { display:flex;flex-direction:column;gap:8px;margin-top:10px; }
    .overlayControls button { width:100%; }
    .mutedSmall { font-size:13px;color:#9fbdf4 }
    @media (max-width: 980px) {
      .overlayCard { grid-template-columns: 1fr; }
      .overlayRight { order: 2; }
    }
    @media (max-width: 520px) {
      .bigTimer { font-size:28px; }
    }
    /* small */
    @media (max-width: 420px) {
      .wrap { padding: 10px; }
      h1 { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Study Case Gacha â€” 8 Kasus untuk Praktikum</h1>
        <div style="color:#9fbdf4;font-size:13px;margin-top:6px">Klik "GACHA" untuk dapatkan study case random. Tekan pada kartu untuk lihat detail dan permission.</div>
      </div>
      <div class="controls" role="toolbar" aria-label="controls">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="gachaBtn" type="button">ðŸŽ² GACHA</button>
          <span id="gachaTimer" style="font-size:13px;color:#9fbdf4;min-width:80px;text-align:center"></span>
        </div>
        <button class="secondary" id="pickAgain" type="button">Pick again</button>
        <button class="secondary" id="exportSelected" type="button">Export JSON</button>
        <button class="secondary" id="openPermGuide" type="button">Permission Guide</button>
      </div>
    </header>

    <main>
      <div class="grid" id="grid" role="list"></div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <div style="font-size:13px;color:#9fbdf4">Dipilih:</div>
        <div id="pickedLabel" style="font-weight:700;color:var(--accent)">Tidak ada</div>
      </div>
    </main>
  </div>

  <!-- existing modals -->
  <div class="modalWrap" id="modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="modalTitle">Title</h3>
      <div style="display:flex;gap:8px">
        <button class="secondary" id="copyBtn" type="button">Copy</button>
        <button id="closeModal" type="button">Close</button>
      </div>
    </div>
    <div class="steps" id="modalSteps"></div>
    <div class="permTable" id="modalPerms"></div>
  </div>
  </div>

  <div class="modalWrap" id="permGuide" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Permission Guide â€” Penjelasan & Contoh</h3>
      <div>
        <button class="secondary" id="copyGuide" type="button">Copy All</button>
        <button id="closeGuide" type="button">Close</button>
      </div>
    </div>
    <div class="steps" style="max-height:60vh;overflow:auto">
      <h4>Format: Folder / File â€” Group â€” Permission (kata)</h4>
      <div id="guideContent" style="margin-top:8px"></div>
    </div>
  </div>
  </div>

  <div class="modalWrap" id="copyModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Copy (manual)</h3>
      <div>
        <button id="closeCopy" type="button">Close</button>
      </div>
    </div>
    <div class="steps copyModalContent">
      <div style="font-size:13px;color:#9fbdf4">Jika browser memblokir Clipboard API, salin teks di bawah secara manual (Ctrl/Cmd + C)</div>
      <textarea class="copyArea" id="copyArea" readonly></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button id="selectAll" type="button">Select All</button></div>
    </div>
  </div>
  </div>

  <!-- NEW: full screen overlay shown immediately after GACHA -->
  <div class="overlayFull" id="postGachaOverlay" aria-hidden="true">
    <div class="overlayCard" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
      <div class="overlayLeft">
        <h2 id="overlayTitle">Study Case</h2>
        <p id="overlaySubtitle">Ini ringkasan study case yang kamu dapatkan.</p>

        <div class="stepsSummary" id="overlaySummary"></div>

        <div style="margin-top:12px">
          <strong>Permissions singkat:</strong>
          <div id="overlayPermsShort" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="overlayRight">
        <div class="mutedSmall">Sisa waktu</div>
        <div id="overlayTimerBig" class="bigTimer">--:--</div>
        <div class="progressBar"><div id="overlayProgress" class="progressFill" style="width:0%"></div></div>

        <div class="overlayControls">
          <button id="startGachaLock" class="bigBtn" style="background:var(--accent);color:#04243a">START</button>
          <button id="hideOverlay" class="secondary">Hide (keep timer)</button>
          <button id="stopTimer" class="secondary">Stop (cancel)</button>
        </div>

        <div style="margin-top:8px" class="mutedSmall">Timer akan aktif setelah tekan START. Kamu bisa menutup overlay tanpa menghentikan timer dengan tombol Hide.</div>
      </div>
    </div>
  </div>

  <script>
    // SETTINGS
    const GACHA_COOLDOWN_MINUTES = 20; // 20 menit
    const STORAGE_KEY = 'lastGachaData_v2'; // store {ts, id}
    // helper clipboard
    function showCopyModal(text){
      const modal = document.getElementById('copyModal');
      const area = document.getElementById('copyArea');
      area.value = text;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=> { area.focus(); area.select(); }, 80);
    }
    document.getElementById('closeCopy').addEventListener('click', ()=> {
      document.getElementById('copyModal').style.display='none';
      document.getElementById('copyModal').setAttribute('aria-hidden','true');
    });
    document.getElementById('selectAll').addEventListener('click', ()=>{ document.getElementById('copyArea').select(); });
    async function safeCopy(text){
      try { if(navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(text); return true; } } catch (err) {}
      showCopyModal(text); return false;
    }

    // STUDY CASES (kept full)
    const studyCases = [
      {
        id:1, title: 'DroneLab Research Server',
        steps: [
          'Buat direktori DroneLab dengan subfolder firmware, data, dan logs.',
          'Buat tiga grup DevTeam, PilotTeam, AnalystTeam.',
          'Tambahkan 6 user; 2 user per grup.',
          'Buat file contoh core.sh (firmware), flight.csv (data), test.log (logs).',
          'Atur permission file sesuai kebutuhan tiap tim.',
          'Atur password expiry untuk pilot1 menjadi 20 hari.',
          'Verifikasi struktur direktori dan pengaturan password pilot1.'
        ],
        perms: [
          {item:'firmware/','group':'DevTeam','perm':'Read, Write, Execute (folder)'},
          {item:'core.sh','group':'DevTeam','perm':'Read, Write (file)'},
          {item:'data/','group':'PilotTeam','perm':'Read, Write, Execute (folder)'},
          {item:'flight.csv','group':'PilotTeam','perm':'Read, Write (file)'},
          {item:'logs/','group':'AnalystTeam','perm':'Read, Write, Execute (folder)'},
          {item:'test.log','group':'AnalystTeam','perm':'Read, Write (file)'}
        ]
      },
      { id:2, title:'CyberSecurity Incident Center', steps:[ 'Buat direktori IncidentCenter: incident, analysis, report.', 'Buat grup Responder, Forensic, Manager.', 'Tambahkan 6 user, 2 tiap grup.', 'Buat file case001.txt, findings.txt, final.pdf.', 'Atur permission: incident (Responder), analysis (Forensic), report (semua).', 'Atur password expiry forensic1 = 15 hari.', 'Verifikasi struktur & chage forensic1.' ], perms:[ {item:'incident/','group':'Responder','perm':'Read, Write, Execute (folder)'},{item:'case001.txt','group':'Responder','perm':'Read, Write (file)'},{item:'analysis/','group':'Forensic','perm':'Read, Write, Execute (folder)'},{item:'findings.txt','group':'Forensic','perm':'Read, Write (file)'},{item:'report/','group':'All Users','perm':'Read, Execute (folder)'},{item:'final.pdf','group':'All Users','perm':'Read (file)'} ] },
      { id:3, title:'SmartFactory Automation System', steps:[ 'Buat direktori SmartFactory: sensor, control, maintenance.', 'Buat grup SensorTeam, ControlTeam, MaintTeam.', 'Buat 6 user, 2 per grup.', 'Buat temp.txt, robot.cfg, maint.log.', 'Atur permission sesuai operasional pabrik.', 'Atur password expiry control1 = 30 hari.', 'Verifikasi direktori & status password control1.' ], perms:[ {item:'sensor/','group':'SensorTeam','perm':'Read, Write, Execute (folder)'},{item:'temp.txt','group':'SensorTeam','perm':'Read, Write (file)'},{item:'control/','group':'ControlTeam','perm':'Read, Write, Execute (folder)'},{item:'robot.cfg','group':'ControlTeam','perm':'Read, Write (file)'},{item:'maintenance/','group':'MaintTeam','perm':'Read, Write, Execute (folder)'},{item:'maint.log','group':'MaintTeam','perm':'Read, Write (file)'} ] },
      { id:4, title:'MediaStudio Editing Server', steps:[ 'Buat direktori MediaStudio: raw, edit, export.', 'Buat grup Editor, Renderer, Producer.', 'Tambahkan user: 4 editor/renderer, 2 producer.', 'Buat footage.mp4, timeline.edt, final.mp4.', 'Atur permission: raw (Editor), edit (Editor+Renderer), export (semua).', 'Atur password expiry editor1 = 40 hari.', 'Verifikasi direktori & password editor1.' ], perms:[ {item:'raw/','group':'Editor','perm':'Read, Write, Execute (folder)'},{item:'footage.mp4','group':'Editor','perm':'Read, Write (file)'},{item:'edit/','group':'Editor & Renderer','perm':'Read, Write, Execute (folder)'},{item:'timeline.edt','group':'Editor & Renderer','perm':'Read, Write (file)'},{item:'export/','group':'All Users','perm':'Read, Execute (folder)'},{item:'final.mp4','group':'All Users','perm':'Read (file)'} ] },
      { id:5, title:'Hospital Medical Records Server', steps:[ 'Buat direktori HosData: patients, doctors, finance.', 'Buat grup MedTeam, DocTeam, FinTeam.', 'Tambahkan 6 user sesuai kelompok.', 'Buat list.txt, schedule.txt, salary.csv.', 'Atur permission: patients (MedTeam), doctors (DocTeam), finance (FinTeam).', 'Atur password expiry fin1 = 25 hari.', 'Verifikasi akses & kadaluarsa fin1.' ], perms:[ {item:'patients/','group':'MedTeam','perm':'Read, Write, Execute (folder)'},{item:'list.txt','group':'MedTeam','perm':'Read, Write (file)'},{item:'doctors/','group':'DocTeam','perm':'Read, Write, Execute (folder)'},{item:'schedule.txt','group':'DocTeam','perm':'Read, Write (file)'},{item:'finance/','group':'FinTeam','perm':'Read, Write, Execute (folder)'},{item:'salary.csv','group':'FinTeam','perm':'Read, Write (file)'} ] },
      { id:6, title:'E-Learning Server Management', steps:[ 'Buat direktori ElearnSys: lectures, assignments, grading.', 'Buat grup Teacher, Student, Assessor.', 'Tambahkan 6 user dan bagi sesuai grup.', 'Buat week1.pdf, task1.docx, grade.txt.', 'Atur permission sesuai kebutuhan e-learning.', 'Atur password expiry assessor1 = 10 hari.', 'Verifikasi permission & chage assessor1.' ], perms:[ {item:'lectures/','group':'Teacher','perm':'Read, Write, Execute (folder)'},{item:'week1.pdf','group':'Teacher','perm':'Read, Write (file)'},{item:'assignments/','group':'Student','perm':'Read, Write, Execute (folder)'},{item:'task1.docx','group':'Student','perm':'Read, Write (file)'},{item:'grading/','group':'Assessor','perm':'Read, Write, Execute (folder)'},{item:'grade.txt','group':'Assessor','perm':'Read, Write (file)'} ] },
      { id:7, title:'GameStudio Asset Build System', steps:[ 'Buat direktori GameBuild: source, assets, build.', 'Buat grup Coder, Artist, Builder.', 'Buat 6 user sesuai grup.', 'Buat main.cpp, character.png, release.exe.', 'Atur permission: source (Coder), assets (Artist), build (Builder).', 'Atur password expiry builder1 = 35 hari.', 'Verifikasi semua setting & expiry builder1.' ], perms:[ {item:'source/','group':'Coder','perm':'Read, Write, Execute (folder)'},{item:'main.cpp','group':'Coder','perm':'Read, Write (file)'},{item:'assets/','group':'Artist','perm':'Read, Write, Execute (folder)'},{item:'character.png','group':'Artist','perm':'Read (file)'},{item:'build/','group':'Builder','perm':'Read, Write, Execute (folder)'},{item:'release.exe','group':'Builder','perm':'Read, Write, Execute (file)'} ] },
      { id:8, title:'Network Infrastructure Configuration Server', steps:[ 'Buat direktori NetInfra: configs, tools, netlog.', 'Buat grup NetAdmin, Operator, Observer.', 'Tambahkan 6 user sesuai grup.', 'Buat router.cfg, ping.sh, history.log.', 'Atur permission sesuai kebutuhan jaringan.', 'Atur password expiry netadmin1 = 20 hari.', 'Verifikasi struktur & chage netadmin1.' ], perms:[ {item:'configs/','group':'NetAdmin','perm':'Read, Write, Execute (folder)'},{item:'router.cfg','group':'NetAdmin','perm':'Read, Write (file)'},{item:'tools/','group':'Operator','perm':'Read, Write, Execute (folder)'},{item:'ping.sh','group':'Operator','perm':'Read, Write, Execute (file)'},{item:'netlog/','group':'Observer','perm':'Read, Execute (folder)'},{item:'history.log','group':'Observer','perm':'Read (file)'} ] }
    ];

    // render grid
    const grid = document.getElementById('grid');
    function renderGrid(){
      grid.innerHTML = '';
      studyCases.forEach(sc=>{
        const c = document.createElement('article');
        c.className = 'card';
        c.id = 'sc-'+sc.id;
        c.innerHTML = `
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between">
              <h3>${sc.title}</h3>
              <span class="tag">#${String(sc.id).padStart(2,'0')}</span>
            </div>
            <p>${sc.steps.slice(0,2).join(' ')}...</p>
          </div>
          <div class="footer">
            <small style="color:#9fbdf4">${sc.steps.length} langkah</small>
            <div style="display:flex;align-items:center">
              <button class="secondary open-btn" data-id="${sc.id}" type="button">Lihat</button>
              <!-- placeholder for per-card timer -->
              <div class="card-timer" data-for="${sc.id}" style="display:none;"></div>
            </div>
          </div>
        `;
        c.addEventListener('click',(e)=>{
          if (e.target.closest('button')) return;
          selectCard(sc.id);
        });
        const btn = c.querySelector('.open-btn');
        btn.addEventListener('click',(e)=>{
          e.stopPropagation();
          openModal(sc.id);
          selectCard(sc.id);
        });
        grid.appendChild(c);
      })
    }
    renderGrid();

    // selection
    let picked = null;
    const pickedLabel = document.getElementById('pickedLabel');
    function selectCard(id){
      document.querySelectorAll('.card').forEach(el=>el.classList.remove('selected'));
      const el = document.getElementById('sc-'+id);
      if(el) el.classList.add('selected');
      picked = studyCases.find(s=>s.id===id);
      pickedLabel.textContent = picked ? picked.title : 'Tidak ada';
    }

    // modal handlers
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalSteps = document.getElementById('modalSteps');
    const modalPerms = document.getElementById('modalPerms');
    function openModal(id){
      const sc = studyCases.find(s=>s.id===id);
      if(!sc) return;
      modalTitle.textContent = sc.title;
      modalSteps.innerHTML = '<ol>' + sc.steps.map(st=>`<li>${st}</li>`).join('') + '</ol>';
      modalPerms.innerHTML = '<strong>Permissions (kata):</strong>' + sc.perms.map(p=>`
<div class="permRow"><div>${p.item} â€” <em>${p.group}</em></div><div>${p.perm}</div></div>`).join('');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=> document.getElementById('closeModal').focus(), 80);
    }
    function closeModalUI(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
    document.getElementById('closeModal').addEventListener('click', ()=> closeModalUI());
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      if(!picked){ alert('Belum ada study case yang dipilih.'); return }
      const text = `${picked.title}\n\n${picked.steps.map((s,i)=>`${i+1}. ${s}`).join('\n')}\n\nPermissions:\n${picked.perms.map(p=>`${p.item} â€” ${p.group} â€” ${p.perm}`).join('\n')}`;
      const ok = await safeCopy(text);
      if(ok) alert('Tersalin ke clipboard');
    });

    // permission guide handlers
    const permGuide = document.getElementById('permGuide');
    const guideContent = document.getElementById('guideContent');
    document.getElementById('openPermGuide').addEventListener('click', ()=>{
      guideContent.innerHTML = '';
      studyCases.forEach(sc=>{
        const el = document.createElement('div');
        el.style.marginBottom = '10px';
        el.innerHTML = `<strong>${sc.title}</strong><div style="margin-top:6px">` + sc.perms.map(p=>`<div style="display:flex;justify-content:space-between;padding:4px 6px;border-bottom:1px dashed rgba(255,255,255,0.02)"><div>${p.item} <small style="color:#9fbdf4">â€” ${p.group}</small></div><div>${p.perm}</div></div>`).join('') + `</div>`;
        guideContent.appendChild(el);
      });
      permGuide.style.display = 'flex';
      permGuide.setAttribute('aria-hidden','false');
    });
    document.getElementById('closeGuide').addEventListener('click', ()=> {
      permGuide.style.display='none';
      permGuide.setAttribute('aria-hidden','true');
    });
    document.getElementById('copyGuide').addEventListener('click', async ()=>{
      const all = studyCases.map(sc=>`${sc.title}\n` + sc.perms.map(p=>`${p.item} â€” ${p.group} â€” ${p.perm}`).join('\n')).join('\n\n');
      const ok = await safeCopy(all);
      if(ok) alert('Semua permission tersalin');
    });

    // GACHA LOCK + TIMER LOGIC (updated to store id)
    const gachaBtn = document.getElementById('gachaBtn');
    const gachaTimerLabel = document.getElementById('gachaTimer');
    let countdownInterval = null;
    let countdownRemaining = 0; // ms
    let countdownEndsAt = null; // epoch ms

    function getLastGachaData(){
      const v = localStorage.getItem(STORAGE_KEY);
      return v ? JSON.parse(v) : null; // {ts, id}
    }
    function setLastGachaData(obj){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }
    function clearLastGachaData(){ localStorage.removeItem(STORAGE_KEY); }

    function msRemainingFrom(timestamp){
      const cooldownMs = GACHA_COOLDOWN_MINUTES * 60 * 1000;
      const elapsed = Date.now() - timestamp;
      return Math.max(0, cooldownMs - elapsed);
    }

    function formatMsAsMMSS(ms){
      const totalSec = Math.ceil(ms/1000);
      const minutes = Math.floor(totalSec / 60);
      const seconds = totalSec % 60;
      return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }

    // per-card timer UI
    function showTimerOnCard(cardId, text){
      const el = document.querySelector(`.card-timer[data-for="${cardId}"]`);
      if(el){
        el.style.display = 'inline-block';
        el.textContent = text;
      }
    }
    function hideTimerOnCard(cardId){
      const el = document.querySelector(`.card-timer[data-for="${cardId}"]`);
      if(el){ el.style.display = 'none'; el.textContent = ''; }
    }

    function startCountdown(ms, cardId){
      if(countdownInterval) clearInterval(countdownInterval);
      countdownRemaining = ms;
      countdownEndsAt = Date.now() + ms;
      updateAllDisplays(countdownRemaining, cardId);
      gachaBtn.disabled = true;
      gachaBtn.setAttribute('aria-disabled','true');

      countdownInterval = setInterval(()=>{
        const rem = Math.max(0, countdownEndsAt - Date.now());
        countdownRemaining = rem;
        if(rem <= 0){
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownRemaining = 0;
          countdownEndsAt = null;
          gachaTimerLabel.textContent = '';
          gachaBtn.disabled = false;
          gachaBtn.removeAttribute('aria-disabled');
          if(cardId) hideTimerOnCard(cardId);
          // reset overlay UI if open
          document.getElementById('overlayTimerBig').textContent = '--:--';
          document.getElementById('overlayProgress').style.width = '0%';
          clearLastGachaData();
        } else {
          updateAllDisplays(rem, cardId);
        }
      }, 250);
    }

    function updateAllDisplays(ms, cardId){
      const txt = formatMsAsMMSS(ms);
      gachaTimerLabel.textContent = txt;
      if(cardId) showTimerOnCard(cardId, txt);
      // overlay big timer + progress
      const data = getLastGachaData();
      const totalMs = GACHA_COOLDOWN_MINUTES * 60 * 1000;
      const pct = Math.max(0, Math.min(100, ((totalMs - ms) / totalMs) * 100));
      const overlayTimerBig = document.getElementById('overlayTimerBig');
      const overlayProgress = document.getElementById('overlayProgress');
      if(overlayTimerBig && overlayProgress){
        overlayTimerBig.textContent = txt;
        overlayProgress.style.width = pct + '%';
      }
    }

    function checkGachaLockOnLoad(){
      const data = getLastGachaData();
      if(!data || !data.ts) {
        gachaTimerLabel.textContent = '';
        gachaBtn.disabled = false;
        document.querySelectorAll('.card-timer').forEach(el=>{ el.style.display='none'; el.textContent=''; });
        return;
      }
      const rem = msRemainingFrom(data.ts);
      if(rem <= 0){
        clearLastGachaData();
        gachaTimerLabel.textContent = '';
        gachaBtn.disabled = false;
        document.querySelectorAll('.card-timer').forEach(el=>{ el.style.display='none'; el.textContent=''; });
      } else {
        // show timer on stored card id, but do not open overlay automatically
        startCountdown(rem, data.id);
      }
    }

    // POST-GACHA OVERLAY ELEMENTS
    const postOverlay = document.getElementById('postGachaOverlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlaySubtitle = document.getElementById('overlaySubtitle');
    const overlaySummary = document.getElementById('overlaySummary');
    const overlayPermsShort = document.getElementById('overlayPermsShort');
    const overlayTimerBig = document.getElementById('overlayTimerBig');
    const overlayProgress = document.getElementById('overlayProgress');
    const startGachaLockBtn = document.getElementById('startGachaLock');
    const hideOverlayBtn = document.getElementById('hideOverlay');
    const stopTimerBtn = document.getElementById('stopTimer');

    let justPicked = null;

    // main GACHA handler: show overlay with START
    document.getElementById('gachaBtn').addEventListener('click', ()=>{
      const data = getLastGachaData();
      if(data && data.ts){
        const rem = msRemainingFrom(data.ts);
        if(rem > 0){
          alert(`Sudah pernah GACHA. Coba lagi setelah ${formatMsAsMMSS(rem)}`);
          return;
        }
      }

      // pick random
      const random = studyCases[Math.floor(Math.random()*studyCases.length)];
      justPicked = random;

      overlayTitle.textContent = random.title;
      overlaySubtitle.textContent = 'Ini ringkasan study case yang kamu dapatkan.';
      overlaySummary.innerHTML = `<ol>${random.steps.map(s=>`<li>${s}</li>`).join('')}</ol>`;
      overlayPermsShort.innerHTML = random.perms.map(p=>`<div style="display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.02)"><div>${p.item} <small style="color:#9fbdf4">â€” ${p.group}</small></div><div>${p.perm}</div></div>`).join('');

      // reset overlay controls (START shown)
      startGachaLockBtn.style.display = 'block';
      hideOverlayBtn.style.display = 'inline-block';
      stopTimerBtn.style.display = 'none';
      overlayTimerBig.textContent = '--:--';
      overlayProgress.style.width = '0%';

      postOverlay.style.display = 'flex';
      postOverlay.setAttribute('aria-hidden','false');
      setTimeout(()=> startGachaLockBtn.focus(), 80);
    });

    // START: begin timer, save {ts, id}, keep overlay open and show big timer
    startGachaLockBtn.addEventListener('click', ()=>{
      if(!justPicked) return;
      selectCard(justPicked.id);

      const now = Date.now();
      setLastGachaData({ ts: now, id: justPicked.id });
      const cooldownMs = GACHA_COOLDOWN_MINUTES * 60 * 1000;
      startCountdown(cooldownMs, justPicked.id);

      // update overlay controls: hide START, show Stop
      startGachaLockBtn.style.display = 'none';
      stopTimerBtn.style.display = 'inline-block';

      // keep overlay open (so user can see big timer + question)
      // optionally auto-open modal details
      openModal(justPicked.id);

      justPicked = null;
    });

    // Hide overlay (keep timer running)
    hideOverlayBtn.addEventListener('click', ()=>{
      postOverlay.style.display = 'none';
      postOverlay.setAttribute('aria-hidden','true');
    });

    // Stop timer (cancel)
    stopTimerBtn.addEventListener('click', ()=>{
      if(!confirm('Hentikan timer? Ini akan membatalkan lock GACHA.')) return;
      if(countdownInterval) clearInterval(countdownInterval);
      countdownInterval = null;
      countdownRemaining = 0;
      countdownEndsAt = null;
      gachaTimerLabel.textContent = '';
      gachaBtn.disabled = false;
      gachaBtn.removeAttribute('aria-disabled');
      // hide card timers
      const data = getLastGachaData();
      if(data && data.id) hideTimerOnCard(data.id);
      // reset overlay UI
      overlayTimerBig.textContent = '--:--';
      overlayProgress.style.width = '0%';
      startGachaLockBtn.style.display = 'block';
      stopTimerBtn.style.display = 'none';
      clearLastGachaData();
    });

    // allow clicking backdrop to close overlay (doesn't stop timer)
    postOverlay.addEventListener('click', (e)=>{
      if(e.target === postOverlay){
        postOverlay.style.display = 'none';
        postOverlay.setAttribute('aria-hidden','true');
      }
    });

    // pick again
    document.getElementById('pickAgain').addEventListener('click', ()=>{
      if(!picked){
        gachaBtn.click();
        return;
      }
      let pool = studyCases.filter(s=>s.id!==picked.id);
      if(pool.length === 0) pool = [...studyCases];
      const random = pool[Math.floor(Math.random()*pool.length)];
      selectCard(random.id);
      openModal(random.id);
    });

    // export selected JSON
    document.getElementById('exportSelected').addEventListener('click', ()=>{
      if(!picked){ alert('Belum ada study case terpilih.'); return }
      const blob = new Blob([JSON.stringify(picked, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `studycase-${picked.id}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // accessibility: close modal on backdrop click
    document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target===document.getElementById('modal')) closeModalUI() });
    document.getElementById('permGuide').addEventListener('click', (e)=>{ if(e.target===document.getElementById('permGuide')) { permGuide.style.display='none'; permGuide.setAttribute('aria-hidden','true'); } });

    // Esc to close overlays/modals
    document.addEventListener('keydown',(e)=>{
      if(e.key === 'Escape'){
        if(document.getElementById('modal').style.display === 'flex') closeModalUI();
        if(document.getElementById('permGuide').style.display === 'flex'){ permGuide.style.display='none'; permGuide.setAttribute('aria-hidden','true'); }
        if(document.getElementById('copyModal').style.display === 'flex'){ document.getElementById('copyModal').style.display='none'; document.getElementById('copyModal').setAttribute('aria-hidden','true'); }
        if(document.getElementById('postGachaOverlay').style.display === 'flex'){ postOverlay.style.display='none'; postOverlay.setAttribute('aria-hidden','true'); justPicked = null; }
      }
    });

    // on load: check stored lock and show timer on card if active
    checkGachaLockOnLoad();
  </script>
</body>
</html>
