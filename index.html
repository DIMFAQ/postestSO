<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Study Case Gacha ‚Äî Semua 8 Kasus (Bahasa Indonesia)</title>
  <style>
    :root{
      --bg:#071024;
      --card:#071427;
      --accent:#60a5fa;
      --muted:#93c5fd33;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --gap:12px;
      --text:#e6eef8;
      --muted-text:#9fbdf4;
      --max-read-width:760px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#071023 0%, #041022 85%); color:var(--text); -webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:0;padding:9px 12px;border-radius:10px;color:#04243a;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:7px 10px;border-radius:10px}
    button[disabled]{opacity:0.45;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:var(--gap);margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-height:120px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:transform .12s}
    .card:hover{transform:translateY(-6px)}
    .card h3{margin:0 0 8px 0;font-size:15px}
    .card p{margin:0;font-size:13px;color:#bcd5efcc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tag{font-size:12px;padding:6px 8px;border-radius:999px;background:var(--glass);display:inline-block;margin-right:6px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .selected{outline:3px solid rgba(96,165,250,0.14);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .card-timer{background:rgba(96,165,250,0.12);color:var(--accent);padding:6px 8px;border-radius:999px;font-weight:700;font-size:13px;min-width:64px;text-align:center;margin-left:8px}
    .modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6), rgba(2,6,23,0.6));backdrop-filter: blur(6px);padding:20px;z-index:50}
    .modal{max-width:920px;width:100%;background:linear-gradient(180deg, #071124, #041023);border-radius:10px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    .steps{margin-top:10px;background:rgba(255,255,255,0.02);padding:14px;border-radius:8px;max-height:64vh;overflow:auto}
    .permTable{margin-top:10px;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02)}
    .permRow{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .permRow:last-child{border-bottom:0}
    .copyModalContent{display:flex;flex-direction:column;gap:8px}
    textarea.copyArea{width:100%;min-height:160px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .overlayFull{position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,23,0.95),rgba(2,6,23,0.98));color:white;display:none;z-index:100;align-items:center;justify-content:center;padding:28px}
    .overlayCard{max-width:1100px;width:100%;background:linear-gradient(180deg,#071124,#041023);border-radius:12px;padding:26px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(2,6,23,0.7);text-align:left;color:#e6eef8;display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
    .overlayLeft{padding-right:8px; max-width: var(--max-read-width);}
    .overlayRight{background:rgba(255,255,255,0.02);padding:16px;border-radius:10px;text-align:center;min-height:160px}
    .overlayCard h2{margin:0 0 6px 0;font-size:20px}
    .overlayCard p.lead{color:#cfe7ffcc;margin:8px 0 14px;font-size:14px;line-height:1.4}
    .bigTimer{font-size:36px;font-weight:800;margin:8px 0;color:var(--accent)}
    .progressBar{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:8px}
    .progressFill{height:100%;width:0%;background:linear-gradient(90deg,rgba(96,165,250,0.9),rgba(96,165,250,0.6));transition:width 0.4s linear}
    .overlayControls{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .overlayControls button{width:100%}
    .mutedSmall{font-size:13px;color:#9fbdf4}
    .descriptionBlock{max-width:100%}
    /* formatted lists */
    .desc-ul{margin:8px 0 8px 20px}
    .desc-ol-alpha{margin:6px 0 6px 28px; list-style-type: lower-alpha;}
    .desc-par{margin:8px 0;color:#d8eefd;white-space:pre-wrap}
    @media (max-width:1100px){ .overlayCard{grid-template-columns:1fr 320px} }
    @media (max-width:900px){ .overlayCard{grid-template-columns:1fr} .overlayRight{order:2} .overlayLeft{max-width:100%} }
    @media (max-width:520px){ .bigTimer{font-size:28px} .card p{white-space:normal} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Study Case Gacha ‚Äî 8 Kasus (Bahasa Indonesia)</h1>
        <div style="color:#9fbdf4;font-size:13px;margin-top:6px">Klik "GACHA" untuk mendapatkan study case acak. Klik kartu untuk lihat detail.</div>
      </div>
      <div class="controls" role="toolbar" aria-label="kontrol">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="gachaBtn" type="button">üé≤ GACHA</button>
          <span id="gachaTimer" style="font-size:13px;color:#9fbdf4;min-width:80px;text-align:center"></span>
        </div>
        <button class="secondary" id="pickAgain" type="button">Pilih lagi</button>
        <button class="secondary" id="exportSelected" type="button">Ekspor JSON</button>
        <button class="secondary" id="openPermGuide" type="button">Panduan Semua</button>
      </div>
    </header>

    <main>
      <div class="grid" id="grid" role="list"></div>
      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <div style="font-size:13px;color:#9fbdf4">Dipilih:</div>
        <div id="pickedLabel" style="font-weight:700;color:var(--accent)">Tidak ada</div>
      </div>
    </main>
  </div>

  <!-- modal -->
  <div class="modalWrap" id="modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h3 id="modalTitle">Judul</h3>
        <div style="display:flex;gap:8px">
          <button class="secondary" id="copyBtn" type="button">Salin</button>
          <button id="closeModal" type="button">Tutup</button>
        </div>
      </div>
      <div class="steps" id="modalSteps"></div>
      <div class="permTable" id="modalPerms"></div>
    </div>
  </div>

  <!-- permission guide -->
  <div class="modalWrap" id="permGuide" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Daftar Semua Study Case</h3>
        <div>
          <button class="secondary" id="copyGuide" type="button">Salin Semua</button>
          <button id="closeGuide" type="button">Tutup</button>
        </div>
      </div>
      <div class="steps" style="max-height:60vh;overflow:auto">
        <div id="guideContent" style="margin-top:8px;white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

  <!-- copy modal -->
  <div class="modalWrap" id="copyModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Salin (manual)</h3>
        <div><button id="closeCopy" type="button">Tutup</button></div>
      </div>
      <div class="steps copyModalContent">
        <div style="font-size:13px;color:#9fbdf4">Jika clipboard diblokir, salin teks di bawah secara manual (Ctrl/Cmd + C)</div>
        <textarea class="copyArea" id="copyArea" readonly></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="selectAll" type="button">Pilih Semua</button></div>
      </div>
    </div>
  </div>

  <!-- post-gacha overlay -->
  <div class="overlayFull" id="postGachaOverlay" aria-hidden="true">
    <div class="overlayCard" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
      <div class="overlayLeft">
        <h2 id="overlayTitle">Study Case</h2>
        <p class="lead" id="overlaySubtitle">Ringkasan study case yang kamu dapatkan.</p>

        <div class="descriptionBlock" id="overlaySummary" aria-live="polite"></div>

        <div style="margin-top:12px">
          <strong>Potongan penting (jika ada):</strong>
          <div id="overlayPermsShort" style="margin-top:8px"></div>
        </div>

      </div>

      <div class="overlayRight">
        <div class="mutedSmall">Sisa waktu</div>
        <div id="overlayTimerBig" class="bigTimer">--:--</div>
        <div class="progressBar"><div id="overlayProgress" class="progressFill" style="width:0%"></div></div>

        <div class="overlayControls">
          <button id="startGachaLock" class="bigBtn" style="background:var(--accent);color:#04243a">MULAI</button>
          <button id="hideOverlay" class="secondary">Sembunyikan (tetap jalan)</button>
          <button id="stopTimer" class="secondary">Berhenti (batalkan)</button>
        </div>

        <div style="margin-top:8px" class="mutedSmall">Timer aktif setelah menekan MULAI. Sembunyikan untuk melihat dashboard ‚Äî timer tetap berjalan.</div>
      </div>
    </div>
  </div>

  <script>
    // jika mau pakai preview image nanti, path di history:
    // const PREVIEW_IMAGE = '/mnt/data/Screenshot 2025-11-24 151011.png';

    // SETTINGS
    const GACHA_COOLDOWN_MINUTES = 20;
    const STORAGE_KEY = 'lastGachaData_allcases_v2';

    // STUDY CASES (format {id, title, raw} ‚Äî ISI sesuai permintaan)
    const studyCases = [
`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk sebuah proyek bernama ProjectX. Dalam proyek ini dibutuhkan:
‚óè Direktori utama ProjectX yang berisi 2 subdirektori: usersetup dan workdir.
‚óè Tiga grup kolaborasi: Dev, QA, dan Prod.
‚óè Enam pengguna: masing-masing grup memiliki 2 anggota (username bebas).
‚óè Di dalam workdir dibuat tiga file (misal fileA.sh, fileB.txt, fileC.log) yang akan diatur izin aksesnya sesuai kebutuhan:
a. fileA.sh ‚Üí pemilik: read, write, execute; grup: read, execute; selainnya: read.
b. fileB.txt ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
c. fileC.log ‚Üí pemilik: read, write, execute; grup & lainnya: tidak ada akses.
‚óè Salah satu user dari grup Dev diatur agar masa berlaku password-nya berakhir setelah 15 hari.
‚óè Seluruh isi ProjectX kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`,

`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk sebuah projek penelitian drone. Dalam proyek ini dibutuhkan:
‚óè Direktori utama DroneLab yang berisi 3 subdirektori: firmware, data, logs.
‚óè Tiga grup kolaborasi: DevTeam, PilotTeam, AnalystTeam.
‚óè Enam pengguna: masing-masing grup memiliki 2 anggota (username bebas).
‚óè Di dalam data dibuat tiga file contoh (core.sh, flight.csv, test.log) yang akan diatur izin aksesnya sebagai contoh kebutuhan nyata:
a. core.sh ‚Üí pemilik: read, write, execute; grup: read, write; selainnya: tidak ada akses.
b. flight.csv ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
c. test.log ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
‚óè Salah satu user dari grup PilotTeam diatur agar masa berlaku password-nya berakhir setelah 20 hari.
‚óè Seluruh isi DroneLab kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`,

`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk pusat insiden keamanan siber. Dalam proyek ini dibutuhkan:
‚óè Direktori utama IncidentCenter yang berisi 3 subdirektori: incident, analysis, report.
‚óè Tiga grup kolaborasi: Responder, Forensic, Manager.
‚óè Enam pengguna: masing-masing grup memiliki 2 anggota (username bebas).
‚óè Di dalam incident dan analysis dibuat dua file utama (incident/case001.txt, analysis/findings.txt):
a. incident/case001.txt ‚Üí pemilik: read, write; grup: read, write (hanya anggota Responder); selainnya: tidak ada akses.
b. analysis/findings.txt ‚Üí pemilik: read, write; grup: read, write (hanya anggota Forensic); selainnya: tidak ada akses.
c. report/ ‚Üí direktori publik: pemilik & grup: baca, eksekusi; selainnya: baca.
‚óè Salah satu user dari grup Forensic diatur agar masa berlaku password-nya berakhir setelah 12 hari.
‚óè Seluruh isi IncidentCenter kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`,

`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk sistem otomasi pabrik. Dalam proyek ini dibutuhkan:
‚óè Direktori utama SmartFactory yang berisi 3 subdirektori: sensor, control, maintenance.
‚óè Tiga grup kolaborasi: SensorTeam, ControlTeam, MaintTeam.
‚óè Enam pengguna: masing-masing grup memiliki 2 anggota (username bebas).
‚óè Di dalam control dan maintenance dibuat tiga file contoh (temp.txt, robot.cfg, maint.log):
a. temp.txt ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
b. robot.cfg ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
c. maint.log ‚Üí pemilik: read, write; grup & lain: tidak ada akses.
‚óè Salah satu user dari grup ControlTeam diatur agar masa berlaku password-nya berakhir setelah 30 hari.
‚óè Seluruh isi SmartFactory kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`,

`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk server editing media. Dalam proyek ini dibutuhkan:
‚óè Direktori utama MediaStudio yang berisi 3 subdirektori: raw, edit, export.
‚óè Tiga grup kolaborasi: Editor, Renderer, Producer.
‚óè Enam pengguna: beberapa user untuk editing dan rendering (2 per grup, username bebas).
‚óè Di dalam raw, edit, export dibuat tiga file contoh (footage.mp4, timeline.edt, final.mp4):
a. footage.mp4 ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
b. timeline.edt ‚Üí pemilik: read, write; grup: read, write; selainnya: tidak ada akses.
c. final.mp4 ‚Üí pemilik: read; grup: read; selainnya: read.
‚óè Salah satu user dari grup Editor diatur agar masa berlaku password-nya berakhir setelah 25 hari.
‚óè Seluruh isi MediaStudio kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`,

`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk server rekam medis rumah sakit. Dalam proyek ini dibutuhkan:
‚óè Direktori utama HosData yang berisi 3 subdirektori: patients, doctors, finance.
‚óè Tiga grup kolaborasi: MedTeam, DocTeam, FinTeam.
‚óè Enam pengguna: masing-masing grup memiliki 2 anggota (username bebas).
‚óè Di dalam patients, doctors, finance dibuat tiga file contoh (list.txt, schedule.txt, salary.csv):
a. list.txt ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
b. schedule.txt ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
c. salary.csv ‚Üí pemilik: read, write; grup & lain: tidak ada akses.
‚óè Salah satu user dari grup FinTeam diatur agar masa berlaku password-nya berakhir setelah 18 hari.
‚óè Seluruh isi HosData kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`,

`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk platform e-learning. Dalam proyek ini dibutuhkan:
‚óè Direktori utama ElearnSys yang berisi 3 subdirektori: lectures, assignments, grading.
‚óè Tiga grup kolaborasi: Teacher, Student, Assessor.
‚óè Enam pengguna: masing-masing grup memiliki 2 anggota (username bebas).
‚óè Di dalam assignments dan grading dibuat tiga file contoh (week1.pdf, task1.docx, grade.txt):
a. week1.pdf ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
b. task1.docx ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
c. grade.txt ‚Üí pemilik: read, write; grup & lain: tidak ada akses.
‚óè Salah satu user dari grup Assessor diatur agar masa berlaku password-nya berakhir setelah 10 hari.
‚óè Seluruh isi ElearnSys kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`,

`Kasus:
Seorang administrator sistem diminta menyiapkan direktori kerja dan setup akses untuk pengembangan game (GameBuild). Dalam proyek ini dibutuhkan:
‚óè Direktori utama GameBuild yang berisi 3 subdirektori: source, assets, build.
‚óè Tiga grup kolaborasi: Coder, Artist, Builder.
‚óè Enam pengguna: masing-masing grup memiliki 2 anggota (username bebas).
‚óè Di dalam subdirektori dibuat tiga file contoh (main.cpp, character.png, release.exe) yang akan diatur izin aksesnya sebagai contoh kebutuhan nyata:
a. main.cpp ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
b. character.png ‚Üí pemilik: read, write; grup: read; selainnya: tidak ada akses.
c. release.exe ‚Üí pemilik: read, write, execute; grup: execute; selainnya: tidak ada akses.
‚óè Salah satu user dari grup Builder diatur agar masa berlaku password-nya berakhir setelah 20 hari.
‚óè Seluruh isi GameBuild kemudian diverifikasi dengan menampilkan struktur direktori dan izin file.`
    ];

    // render grid
    const grid = document.getElementById('grid');
    function renderGrid(){
      grid.innerHTML = '';
      studyCases.forEach((raw, idx)=>{
        const id = idx+1;
        const title = `Study Case #${id}`;
        const c = document.createElement('article');
        c.className = 'card';
        c.id = 'sc-'+id;
        c.innerHTML = `
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between">
              <h3>${title}</h3>
              <span class="tag">#${String(id).padStart(2,'0')}</span>
            </div>
            <p>${getPreview(raw)}</p>
          </div>
          <div class="footer">
            <small style="color:#9fbdf4">1 deskripsi</small>
            <div style="display:flex;align-items:center">
              <button class="secondary open-btn" data-id="${id}" type="button">Lihat</button>
            </div>
          </div>
        `;
        c.addEventListener('click',(e)=>{ if(e.target.closest('button')) return; selectCard(id); });
        const btn = c.querySelector('.open-btn');
        btn.addEventListener('click',(e)=>{ e.stopPropagation(); openModal(id); selectCard(id); });
        grid.appendChild(c);
      });
    }

    function getPreview(text){
      const firstLine = text.split('\n').find(l=>l.trim().length>0) || '';
      return firstLine.length>120 ? firstLine.slice(0,120)+'...' : firstLine;
    }

    renderGrid();

    // selection
    let picked = null;
    const pickedLabel = document.getElementById('pickedLabel');
    function selectCard(id){
      document.querySelectorAll('.card').forEach(el=>el.classList.remove('selected'));
      const el = document.getElementById('sc-'+id);
      if(el) el.classList.add('selected');
      picked = { id, title:`Study Case #${id}`, description: studyCases[id-1] };
      pickedLabel.textContent = picked ? picked.title : 'Tidak ada';
    }

    // format raw -> HTML (preserve content exactly, convert bullets & letters to lists for display only)
    function formatRawToHTML(raw){
      const lines = raw.split('\n').map(l=>l.replace(/\r/g,''));
      let html = '';
      let inUl = false;
      let inAlpha = false;
      for(let i=0;i<lines.length;i++){
        const line = lines[i].trim();
        if(!line){
          if(inUl){ html += '</ul>'; inUl=false; }
          if(inAlpha){ html += '</ol>'; inAlpha=false; }
          continue;
        }
        if(line.startsWith('Kasus:')){
          const rest = line.substring(6).trim();
          html += `<div class="desc-par"><strong>Kasus:</strong> ${escapeHtml(rest)}</div>`;
          continue;
        }
        if(line.startsWith('‚óè')){
          if(inAlpha){ html += '</ol>'; inAlpha=false; }
          if(!inUl){ html += '<ul class="desc-ul">'; inUl=true; }
          const content = line.replace(/^‚óè\s*/,'').trim();
          html += `<li>${escapeHtml(content)}</li>`;
          continue;
        }
        if(line.match(/^[a-z]\.\s*/i)){
          if(inUl){ html += '</ul>'; inUl=false; }
          if(!inAlpha){ html += '<ol class="desc-ol-alpha">'; inAlpha=true; }
          const content = line.replace(/^[a-z]\.\s*/i,'').trim();
          html += `<li>${escapeHtml(content)}</li>`;
          continue;
        }
        if(inUl){ html += '</ul>'; inUl=false; }
        if(inAlpha){ html += '</ol>'; inAlpha=false; }
        html += `<div class="desc-par">${escapeHtml(line)}</div>`;
      }
      if(inUl) html += '</ul>';
      if(inAlpha) html += '</ol>';
      return html;
    }

    // modal handlers
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalSteps = document.getElementById('modalSteps');

    function openModal(id){
      const raw = studyCases[id-1];
      modalTitle.textContent = `Study Case #${id}`;
      modalSteps.innerHTML = formatRawToHTML(raw);
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=> document.getElementById('closeModal').focus(), 80);
    }
    function closeModalUI(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }
    document.getElementById('closeModal').addEventListener('click', ()=> closeModalUI());

    // copy modal
    function showCopyModal(text){
      const modal = document.getElementById('copyModal');
      const area = document.getElementById('copyArea');
      area.value = text;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=> { area.focus(); area.select(); }, 80);
    }
    document.getElementById('closeCopy').addEventListener('click', ()=> {
      document.getElementById('copyModal').style.display='none';
      document.getElementById('copyModal').setAttribute('aria-hidden','true');
    });
    document.getElementById('selectAll').addEventListener('click', ()=>{ document.getElementById('copyArea').select(); });

    async function safeCopy(text){
      try {
        if(navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (err) {}
      showCopyModal(text);
      return false;
    }

    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      if(!picked){ alert('Belum ada study case yang dipilih.'); return }
      const ok = await safeCopy(picked.description);
      if(ok) alert('Tersalin ke clipboard');
    });

    // permission guide (shows raw list)
    const permGuide = document.getElementById('permGuide');
    const guideContent = document.getElementById('guideContent');
    document.getElementById('openPermGuide').addEventListener('click', ()=>{
      guideContent.innerText = studyCases.join('\n\n---\n\n');
      permGuide.style.display = 'flex';
      permGuide.setAttribute('aria-hidden','false');
    });
    document.getElementById('closeGuide').addEventListener('click', ()=> { permGuide.style.display='none'; permGuide.setAttribute('aria-hidden','true'); });
    document.getElementById('copyGuide').addEventListener('click', async ()=>{
      const all = studyCases.join('\n\n---\n\n');
      const ok = await safeCopy(all);
      if(ok) alert('Semua study case tersalin');
    });

    // GACHA + overlay + timer logic
    const gachaBtn = document.getElementById('gachaBtn');
    const gachaTimerLabel = document.getElementById('gachaTimer');
    let countdownInterval = null;
    let countdownEndsAt = null;
    let countdownRemaining = 0;

    function getLastGachaData(){ const v = localStorage.getItem(STORAGE_KEY); return v ? JSON.parse(v) : null; }
    function setLastGachaData(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    function clearLastGachaData(){ localStorage.removeItem(STORAGE_KEY); }
    function msRemainingFrom(timestamp){ const cooldownMs = GACHA_COOLDOWN_MINUTES * 60 * 1000; const elapsed = Date.now() - timestamp; return Math.max(0, cooldownMs - elapsed); }
    function formatMsAsMMSS(ms){ const totalSec = Math.ceil(ms/1000); const minutes = Math.floor(totalSec / 60); const seconds = totalSec % 60; return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`; }

    function startCountdown(ms){
      if(countdownInterval) clearInterval(countdownInterval);
      countdownRemaining = ms;
      countdownEndsAt = Date.now() + ms;
      updateAllDisplays(countdownRemaining);
      gachaBtn.disabled = true;
      gachaBtn.setAttribute('aria-disabled','true');

      countdownInterval = setInterval(()=>{
        const rem = Math.max(0, countdownEndsAt - Date.now());
        countdownRemaining = rem;
        if(rem <= 0){
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownRemaining = 0;
          countdownEndsAt = null;
          gachaTimerLabel.textContent = '';
          gachaBtn.disabled = false;
          gachaBtn.removeAttribute('aria-disabled');
          document.getElementById('overlayTimerBig').textContent = '--:--';
          document.getElementById('overlayProgress').style.width = '0%';
          clearLastGachaData();
        } else {
          updateAllDisplays(rem);
        }
      }, 250);
    }

    function updateAllDisplays(ms){
      const txt = formatMsAsMMSS(ms);
      gachaTimerLabel.textContent = txt;
      const totalMs = GACHA_COOLDOWN_MINUTES * 60 * 1000;
      const pct = Math.max(0, Math.min(100, ((totalMs - ms) / totalMs) * 100));
      const overlayTimerBig = document.getElementById('overlayTimerBig');
      const overlayProgress = document.getElementById('overlayProgress');
      if(overlayTimerBig && overlayProgress){
        overlayTimerBig.textContent = txt;
        overlayProgress.style.width = pct + '%';
      }
    }

    // overlay elements
    const postOverlay = document.getElementById('postGachaOverlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlaySubtitle = document.getElementById('overlaySubtitle');
    const overlaySummary = document.getElementById('overlaySummary');
    const overlayPermsShort = document.getElementById('overlayPermsShort');
    const startGachaLockBtn = document.getElementById('startGachaLock');
    const hideOverlayBtn = document.getElementById('hideOverlay');
    const stopTimerBtn = document.getElementById('stopTimer');
    let justPicked = null;

    gachaBtn.addEventListener('click', ()=>{
      const data = getLastGachaData();
      if(data && data.ts){
        const rem = msRemainingFrom(data.ts);
        if(rem > 0){
          alert(`Sudah pernah GACHA. Coba lagi setelah ${formatMsAsMMSS(rem)}`);
          return;
        }
      }
      const randomIdx = Math.floor(Math.random()*studyCases.length);
      const random = studyCases[randomIdx];
      justPicked = { id: randomIdx+1, desc: random };
      overlayTitle.textContent = `Study Case #${justPicked.id}`;
      overlaySubtitle.textContent = 'Ringkasan study case yang kamu dapatkan.';
      overlaySummary.innerHTML = formatRawToHTML(justPicked.desc);
      // extract any "Salah satu user ..." lines to highlight expiry info
      const expiryLines = justPicked.desc.split('\n').filter(l=>/masa berlaku password|masa berlaku kata sandi|masa berlaku password-nya/i.test(l));
      overlayPermsShort.innerHTML = expiryLines.length ? expiryLines.map(l=>`<div style="padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.02)">${escapeHtml(l.trim())}</div>`).join('') : '<div class="desc-par">Tidak ada catatan expiry khusus.</div>';
      startGachaLockBtn.style.display = 'block';
      hideOverlayBtn.style.display = 'inline-block';
      stopTimerBtn.style.display = 'none';
      document.getElementById('overlayTimerBig').textContent = '--:--';
      document.getElementById('overlayProgress').style.width = '0%';
      postOverlay.style.display = 'flex';
      postOverlay.setAttribute('aria-hidden','false');
      setTimeout(()=> startGachaLockBtn.focus(), 80);
    });

    startGachaLockBtn.addEventListener('click', ()=>{
      if(!justPicked) return;
      selectCard(justPicked.id);
      const now = Date.now();
      setLastGachaData({ ts: now, id: justPicked.id });
      const cooldownMs = GACHA_COOLDOWN_MINUTES * 60 * 1000;
      startCountdown(cooldownMs);
      startGachaLockBtn.style.display = 'none';
      stopTimerBtn.style.display = 'inline-block';
      justPicked = null;
    });

    hideOverlayBtn.addEventListener('click', ()=>{
      postOverlay.style.display = 'none';
      postOverlay.setAttribute('aria-hidden','true');
    });

    stopTimerBtn.addEventListener('click', ()=>{
      if(!confirm('Hentikan timer? Ini akan membatalkan lock GACHA.')) return;
      if(countdownInterval) clearInterval(countdownInterval);
      countdownInterval = null;
      countdownRemaining = 0;
      countdownEndsAt = null;
      gachaTimerLabel.textContent = '';
      gachaBtn.disabled = false;
      gachaBtn.removeAttribute('aria-disabled');
      document.getElementById('overlayTimerBig').textContent = '--:--';
      document.getElementById('overlayProgress').style.width = '0%';
      startGachaLockBtn.style.display = 'block';
      stopTimerBtn.style.display = 'none';
      clearLastGachaData();
    });

    postOverlay.addEventListener('click', (e)=>{
      if(e.target === postOverlay){
        postOverlay.style.display = 'none';
        postOverlay.setAttribute('aria-hidden','true');
      }
    });

    // pick again
    document.getElementById('pickAgain').addEventListener('click', ()=>{
      if(!picked){
        gachaBtn.click();
        return;
      }
      let poolIdxs = studyCases.map((_,i)=>i);
      const currentIdx = picked.id - 1;
      poolIdxs = poolIdxs.filter(i=>i !== currentIdx);
      if(poolIdxs.length === 0) poolIdxs = studyCases.map((_,i)=>i);
      const random = poolIdxs[Math.floor(Math.random()*poolIdxs.length)];
      selectCard(random+1);
      openModal(random+1);
    });

    // export selected JSON
    document.getElementById('exportSelected').addEventListener('click', ()=>{
      if(!picked){ alert('Belum ada study case terpilih.'); return }
      const blob = new Blob([JSON.stringify({ id:picked.id, raw:picked.description }, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `studycase-${picked.id}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // backdrop close and ESC
    document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target===document.getElementById('modal')) closeModalUI() });
    document.getElementById('permGuide').addEventListener('click', (e)=>{ if(e.target===document.getElementById('permGuide')) { permGuide.style.display='none'; permGuide.setAttribute('aria-hidden','true'); } });
    document.getElementById('copyModal').addEventListener('click', (e)=>{ if(e.target===document.getElementById('copyModal')) { document.getElementById('copyModal').style.display='none'; document.getElementById('copyModal').setAttribute('aria-hidden','true'); } });

    document.addEventListener('keydown',(e)=>{
      if(e.key === 'Escape'){
        if(document.getElementById('modal').style.display === 'flex') closeModalUI();
        if(document.getElementById('permGuide').style.display === 'flex'){ permGuide.style.display='none'; permGuide.setAttribute('aria-hidden','true'); }
        if(document.getElementById('copyModal').style.display === 'flex'){ document.getElementById('copyModal').style.display='none'; document.getElementById('copyModal').setAttribute('aria-hidden','true'); }
        if(document.getElementById('postGachaOverlay').style.display === 'flex'){ postOverlay.style.display='none'; postOverlay.setAttribute('aria-hidden','true'); justPicked = null; }
      }
    });

    // small utils
    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // on load: restore lock if present
    (function(){ 
      const data = getLastGachaData();
      if(!data || !data.ts) return;
      const rem = msRemainingFrom(data.ts);
      if(rem > 0) startCountdown(rem);
      else clearLastGachaData();
    })();

  </script>
</body>
</html>
